///////////////////////////////////////////////////////////////
// Import dependencies
///////////////////////////////////////////////////////////////

const express = require("express");
const dotenv = require("dotenv");
const connectDB = require("./config/db");

///////////////////////////////////////////////////////////////
// Import authentication packages
///////////////////////////////////////////////////////////////

const cookieParser = require("cookie-parser"); // Cookie parser for parsing cookies

///////////////////////////////////////////////////////////////
// Import security packages
///////////////////////////////////////////////////////////////
const mongoSanitize = require("express-mongo-sanitize"); // Mongo sanitize for preventing NoSQL injection
const helmet = require("helmet"); // Helmet for setting various HTTP headers for security
const { xss } = require("express-xss-sanitizer"); // XSS sanitizer for preventing XSS attacks
const rateLimit = require("express-rate-limit"); // Rate limiter for preventing brute force attacks
const hpp = require("hpp"); // HPP for preventing HTTP parameter pollution
const cors = require("cors"); // CORS for enabling Cross-Origin Resource Sharing

///////////////////////////////////////////////////////////////
// Load environment variables
///////////////////////////////////////////////////////////////

dotenv.config({ path: "./config/config.env" });

///////////////////////////////////////////////////////////////
// Rate limiter
///////////////////////////////////////////////////////////////

// const limiter = rateLimit({
//   windowsMS: 10 * 60 * 1000, // 10 minutes
//   max: 100,
// });

///////////////////////////////////////////////////////////////
// Initialize express app
///////////////////////////////////////////////////////////////

const app = express();
app.use(express.json());

///////////////////////////////////////////////////////////////
// Use the authentication packages
///////////////////////////////////////////////////////////////

app.use(cookieParser());

///////////////////////////////////////////////////////////////
// Use the security packages
///////////////////////////////////////////////////////////////

app.use(mongoSanitize());
app.use(mongoSanitize());
app.use(helmet());
app.use(xss());
// app.use(limiter);
app.use(hpp());
app.use(cors());

///////////////////////////////////////////////////////////////
// Connect to database
///////////////////////////////////////////////////////////////

connectDB();

///////////////////////////////////////////////////////////////
// Import routes
///////////////////////////////////////////////////////////////

const carProviders = require("./routes/carProviders");
const rentings = require("./routes/rentings");
const auth = require("./routes/auth");

///////////////////////////////////////////////////////////////
// Use routes
///////////////////////////////////////////////////////////////

app.use("/api/v1/carproviders", carProviders);
app.use("/api/v1/rentings", rentings);
app.use("/api/v1/auth", auth);

///////////////////////////////////////////////////////////////
// Set up server
///////////////////////////////////////////////////////////////

const PORT = process.env.PORT || 5000;
const server = app.listen(
  PORT,
  console.log(`Server running in ${process.env.NODE_ENV} mode on port ${PORT}`)
);

///////////////////////////////////////////////////////////////
// Handle unhandled rejections
///////////////////////////////////////////////////////////////

process.on("unhandledRejection", (err, promise) => {
  console.log(`Error: ${err.message}`);
  server.close(() => process.exit(1));
});
